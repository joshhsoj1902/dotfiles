# ~/.zshrc: Main zsh configuration file
# This file is managed by chezmoi and sources modular configuration files
# from ~/.zsh/custom/ for better organization and maintainability

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Convenience functions to insert/append to the path, while not polluting it with
# nonexistent paths on systems where they don't exist
# Source: https://github.com/hairyhenderson/dotfiles/blob/master/zshrc
function pathinsert () {
  if [[ -d $1 ]]; then
    export PATH="$1:$PATH"
  fi
}

function pathappend () {
  if [[ -d $1 ]]; then
    export PATH="$PATH:$1"
  fi
}

# Initialize basic PATH
if [ -x "/usr/libexec/path_helper" ]; then
  eval "$(/usr/libexec/path_helper)"
else
  export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
fi

# Determine Homebrew prefix (needed for path management)
if [ -x /opt/homebrew/bin/brew ]; then
  export HOMEBREW_PREFIX=/opt/homebrew
elif [ -x /home/linuxbrew/.linuxbrew/bin/brew ]; then
  export HOMEBREW_PREFIX=/home/linuxbrew/.linuxbrew
else
  # Only try brew config if brew is in PATH (skip if not available to avoid hanging)
  if command -v brew &> /dev/null && [ -x "$(command -v brew)" ]; then
    export HOMEBREW_PREFIX=$(brew config 2>/dev/null | grep ^HOMEBREW_PREFIX | cut -f2 -d\ 2>/dev/null || echo "")
  fi
fi

# Source modular configuration files
# Order matters: paths first, then oh-my-zsh, then tools and functions
# Note: Files are in ~/.zsh/custom/config/ to avoid oh-my-zsh auto-sourcing them

# Path management (must be sourced early as other modules may depend on paths)
if [[ -f ~/.zsh/custom/config/paths.zsh ]]; then
  source ~/.zsh/custom/config/paths.zsh
fi

# Oh My Zsh configuration
if [[ -f ~/.zsh/custom/config/oh-my-zsh-config.zsh ]]; then
  source ~/.zsh/custom/config/oh-my-zsh-config.zsh
fi

# Tool completions (helm, kubectl, az, etc.)
if [[ -f ~/.zsh/custom/config/tools.zsh ]]; then
  source ~/.zsh/custom/config/tools.zsh
fi

# Custom functions
if [[ -f ~/.zsh/custom/config/functions.zsh ]]; then
  source ~/.zsh/custom/config/functions.zsh
fi

# Aliases
if [[ -f ~/.zsh/custom/config/aliases.zsh ]]; then
  source ~/.zsh/custom/config/aliases.zsh
fi

# Secrets (template file - may not exist on all systems)
if [[ -f ~/.zsh/custom/config/secrets.zsh ]]; then
  source ~/.zsh/custom/config/secrets.zsh
fi

# Powerlevel10k theme (conditional - only on non-server systems)
{{- if not .server }}
if [[ -f ~/.zsh/custom/config/powerlevel10k.zsh ]]; then
  source ~/.zsh/custom/config/powerlevel10k.zsh
fi
{{- end }}

# Homebrew initialization (conditional - only on non-RPI systems)
{{- if not .rpi }}
if [[ -f ~/.zsh/custom/config/brew.zsh ]]; then
  source ~/.zsh/custom/config/brew.zsh
fi
{{- end }}

# NVM initialization
if [[ -f ~/.zsh/custom/config/nvm.zsh ]]; then
  source ~/.zsh/custom/config/nvm.zsh
fi
